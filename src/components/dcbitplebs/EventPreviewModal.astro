---
import { Icon } from 'astro-icon/components';
import type { DCBitPlebsEvent } from '~/types';
import { getFormattedDate } from '~/utils/utils';

export interface Props {
  event: DCBitPlebsEvent;
  id: string;
}

const { event, id } = Astro.props;
const modalId = `event-preview-${id}`;
---

<div
  id={modalId}
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm"
  data-modal
>
  <div
    class="relative mx-4 w-full max-w-3xl max-h-[90vh] bg-white dark:bg-slate-900 rounded-lg shadow-xl flex flex-col overflow-hidden"
    data-modal-content
  >
    <!-- Fixed Header with Frontmatter -->
    <div class="flex-shrink-0 border-b border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-800 px-6 py-4">
      <div class="flex items-start justify-between mb-3">
        <h2 class="text-2xl font-bold font-heading dark:text-slate-300">
          DC BitPlebs #{event.eventNumber}
        </h2>
        <button
          type="button"
          class="text-gray-500 hover:text-gray-700 dark:text-slate-400 dark:hover:text-slate-200 transition-colors"
          data-modal-close
          aria-label="Close modal"
        >
          <Icon name="tabler:x" class="w-6 h-6" />
        </button>
      </div>
      
      <!-- Compact Frontmatter Details -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
        <div class="flex items-center text-muted dark:text-slate-400">
          <Icon name="tabler:calendar" class="w-4 h-4 mr-2 flex-shrink-0" />
          <time datetime={event.date.toISOString()}>{getFormattedDate(event.date)}</time>
          <span class="mx-2">·</span>
          <Icon name="tabler:clock" class="w-4 h-4 mr-1 flex-shrink-0" />
          <span>{event.time}</span>
        </div>
        <div class="flex items-start text-muted dark:text-slate-400">
          <Icon name="tabler:map-pin" class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" />
          <div>
            <span class="font-semibold dark:text-slate-300">{event.venue}</span>
            <span class="mx-1">·</span>
            <span>{event.address}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Scrollable Content -->
    <div class="flex-1 overflow-y-auto px-6 py-4">
      <div
        class="prose prose-sm max-w-none dark:prose-invert dark:prose-headings:text-slate-300 prose-headings:font-heading prose-headings:leading-tight prose-headings:tracking-tight prose-headings:font-bold prose-a:text-primary dark:prose-a:text-blue-400 prose-img:rounded-md prose-img:shadow-lg"
        set:html={event.content}
      />
    </div>
  </div>
</div>

<script define:vars={{ modalId }}>
  const modal = document.getElementById(modalId);
  if (!modal) return;

  const openButtons = document.querySelectorAll(`[data-modal-open="${modalId}"]`);
  const closeButtons = modal.querySelectorAll('[data-modal-close]');
  const modalContent = modal.querySelector('[data-modal-content]');

  function openModal() {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.body.style.overflow = 'hidden';
    // Focus trap
    modalContent?.focus();
  }

  function closeModal() {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    document.body.style.overflow = '';
  }

  // Open modal
  openButtons.forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      openModal();
    });
  });

  // Close modal
  closeButtons.forEach((btn) => {
    btn.addEventListener('click', closeModal);
  });

  // Close on backdrop click
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeModal();
    }
  });

  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
      closeModal();
    }
  });
</script>

